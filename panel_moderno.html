<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Designación de Cargos Jerárquicos > Salón Islas Malvinas</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root{
      /* Colores base */
      --bg:#ffffff;                    /* Fondo principal blanco limpio */
      --panel:#f8fafc;                 /* Paneles y tarjetas gris muy claro */
      --card:#ffffff;                  /* Tarjetas blancas */
      
      /* Colores institucionales */
      --brand-primary:#3B65A3;         /* Azul institucional principal */
      --brand-secondary:#56B4C6;       /* Celeste institucional */
      --brand-light:#E8F1F8;          /* Azul muy claro para fondos */
      --celeste-light:#E8F6F8;        /* Celeste muy claro para acentos */
      
      /* Textos */
      --text-primary:#1e293b;          /* Texto principal oscuro */
      --text-secondary:#64748b;        /* Texto secundario */
      --text-muted:#94a3b8;           /* Texto desactivado */
      
      /* Estados de asientos */
      --seat:#f1f5f9;                 /* Asiento vacío */
      --seat-border:#e2e8f0;          /* Borde asiento */
      --present:#22c55e;              /* Verde presente */
      --absent:#ef4444;               /* Rojo ausente */
      
      /* Roles especiales */
      --role-jurado:#8B5CF6;          /* Violeta para jurados */
      --role-funcionario:#3B65A3;     /* Azul institucional */
      --role-ministro:#F97316;        /* Naranja para ministro */
      --role-custodia:#1F2937;        /* Gris oscuro custodia */
      
      /* Efectos y sombras */
      --shadow-sm:0 1px 2px rgba(59, 101, 163, 0.05);
      --shadow:0 4px 12px rgba(59, 101, 163, 0.1);
      --shadow-lg:0 8px 25px rgba(59, 101, 163, 0.15);
      
      /* Compatibilidad */
      --accent:#56B4C6;               /* Celeste para acentos */
      --brand:#3B65A3;                /* Azul institucional principal */
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:linear-gradient(135deg, #f8fafc 0%, #e8f1f8 30%, #ffffff 70%, #f1f8ff 100%);
      background-attachment:fixed;
      font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      color:var(--text-primary);
      position:relative;
    }
    body::before{
      content:'';
      position:fixed;
      top:0;left:0;right:0;bottom:0;
      background-image:radial-gradient(circle at 25% 25%, rgba(59, 101, 163, 0.03) 0%, transparent 50%),
                       radial-gradient(circle at 75% 75%, rgba(86, 180, 198, 0.03) 0%, transparent 50%);
      pointer-events:none;
      z-index:1;
    }

    /* Encabezado */
    header{
      position:sticky;top:0;z-index:30;
      background:linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(232, 241, 248, 0.95) 50%, rgba(255, 255, 255, 0.98) 100%);
      backdrop-filter:saturate(140%) blur(15px);
      border-bottom:3px solid var(--brand-secondary);
      box-shadow:0 4px 20px rgba(59, 101, 163, 0.1), 0 1px 3px rgba(0,0,0,0.1);
    }
    .wrap{max-width:1400px;margin:0 auto;padding:14px 18px;}
    .topbar{display:flex;align-items:center;gap:14px;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:16px}
    .header-logo{
      width:88px;height:88px;object-fit:contain;border-radius:12px;
      filter:drop-shadow(0 4px 12px rgba(59, 101, 163, 0.2));
      transition:all 0.3s ease;
    }
    .header-logo:hover{
      transform:scale(1.05);
      filter:drop-shadow(0 6px 16px rgba(59, 101, 163, 0.3));
    }
    .title{font-weight:700;letter-spacing:.2px}
    .institution{font-size:.78rem;color:var(--text-secondary);margin:0}
    .system-title{font-size:1.02rem;margin:4px 0 0 0;color:var(--brand-primary);font-weight:700}
    .metrics{display:flex;gap:12px;flex-wrap:wrap}
    .kpi{background:linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));border:2px solid var(--brand-secondary);padding:12px 16px;border-radius:16px;min-width:140px;text-align:center;box-shadow:var(--shadow-sm);transition:all 0.2s ease}
    .kpi:hover{border-color:var(--brand-primary);box-shadow:var(--shadow);transform:translateY(-1px)}
    .kpi .label{display:block;font-size:.72rem;color:#ffffff;margin-bottom:6px;font-weight:600}
    .kpi .val{font-size:1.4rem;font-weight:800;color:#ffffff}

    /* Contenido */
    .content{max-width:1400px;margin:20px auto;display:grid;grid-template-columns:280px 1fr;gap:20px;padding:0 18px;position:relative;z-index:10}

    /* Panel lateral */
    .side{
      background:linear-gradient(145deg, rgba(248, 250, 252, 0.95) 0%, rgba(232, 241, 248, 0.9) 100%);
      border:2px solid var(--brand-light);
      border-top:4px solid var(--brand-secondary);
      border-radius:20px;
      padding:24px;
      box-shadow:0 8px 30px rgba(59, 101, 163, 0.1);
      backdrop-filter:blur(10px);
      position:relative;
      z-index:10;
    }
    .side h3{
      margin:8px 0 20px;
      font-size:1.1rem;
      color:var(--brand-primary);
      font-weight:800;
      border-bottom:2px solid var(--brand-light);
      padding-bottom:12px;
    }
    .legend{display:grid;grid-template-columns:1fr auto;row-gap:10px;column-gap:14px;font-size:.9rem;margin-bottom:20px}
    .dot{width:16px;height:16px;border-radius:6px;border:2px solid var(--brand-light);box-shadow:var(--shadow-sm)}
    .muted{color:var(--text-secondary);font-size:.88rem;font-weight:500}
    .controls{display:grid;gap:14px;margin-top:16px}
    .controls input[type="text"], .controls select{
      width:100%;padding:14px 16px;border-radius:14px;border:2px solid var(--brand-light);background:var(--card);color:var(--text-primary);outline:none;font-size:14px;font-weight:500;box-shadow:var(--shadow-sm)
    }
    .controls input::placeholder{color:var(--text-muted)}
    .controls input:focus, .controls select:focus{border-color:var(--brand-secondary);box-shadow:0 0 0 3px rgba(86, 180, 198, 0.15)}
    button.btn{appearance:none;border:none;border-radius:14px;padding:14px 18px;font-weight:700;color:#ffffff;background:linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));cursor:pointer;transition:all 0.2s ease;font-size:14px;box-shadow:var(--shadow-sm)}
    button.btn:hover{box-shadow:var(--shadow);transform:translateY(-2px)}
    button.secondary{background:var(--card);color:var(--brand-primary);border:2px solid var(--brand-light);box-shadow:var(--shadow-sm)}
    button.secondary:hover{border-color:var(--brand-secondary);box-shadow:var(--shadow);transform:translateY(-1px)}

    /* Área de plano */
    .stage{background:var(--card);border:2px solid var(--brand-light);border-radius:20px;padding:20px;position:relative;box-shadow:var(--shadow-sm)}
    .stage-head{display:flex;align-items:center;gap:16px;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;padding-bottom:16px;border-bottom:2px solid var(--brand-light)}
    .stage-label{font-weight:800;color:var(--brand-primary);font-size:1.2rem}
    .zoom{display:flex;gap:10px;align-items:center}
    .zoom input[type="range"]{width:160px;accent-color:var(--brand-secondary)}
    .connection-status{font-size:13px;color:var(--present);display:flex;align-items:center;gap:8px;background:var(--brand-light);padding:8px 12px;border-radius:12px;font-weight:600}
    .connection-dot{width:10px;height:10px;background:var(--present);border-radius:50%;animation:pulse 2s infinite}

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .sectors{display:grid;gap:20px}

    /* Sector con layout mejorado */
    .sector{
      background:var(--card);
      border-radius:16px;
      padding:20px;
      border:2px solid var(--brand-light);
      border-top:4px solid var(--brand-secondary);
      color:var(--text-primary);
      box-shadow:var(--shadow-sm);
      position:relative;
    }
    .sector-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .sector-title{font-weight:800;font-size:1.1rem;color:var(--brand-primary)}
    .sector-info{color:var(--text-secondary);font-size:0.9rem;font-weight:500}
    .grid{--size:32px;display:grid;grid-template-columns:repeat(10, var(--size));gap:10px;justify-content:center;margin:12px 0}
    .seat{
      width:var(--size);height:var(--size);background:transparent;border:none;display:grid;place-items:center;font-size:.7rem;color:var(--text-secondary);font-weight:800;
      user-select:none;cursor:pointer;transition:all .2s ease;position:relative;transform-style:preserve-3d;
    }
    .seat::before{
  content:'';position:absolute;top:2px;left:50%;transform:translateX(-50%);width:88%;height:45%;
  background:linear-gradient(145deg, var(--seat) 0%, rgba(241, 245, 249, 0.8) 100%);
  border:2px solid var(--seat-border);border-radius:50% 50% 10px 10px;
  box-shadow:0 3px 8px rgba(0,0,0,0.1), 
         inset 0 1px 2px rgba(255,255,255,0.8),
         inset 0 -1px 2px rgba(0,0,0,0.1);
  z-index: 1;
  z-index: 1;
    }
    .seat::after{
  content:'';position:absolute;bottom:2px;left:50%;transform:translateX(-50%);width:78%;height:48%;
  background:linear-gradient(145deg, var(--seat) 0%, rgba(241, 245, 249, 0.9) 100%);
  border:2px solid var(--seat-border);border-radius:10px;
  box-shadow:0 4px 12px rgba(0,0,0,0.15), 
         inset 0 1px 3px rgba(255,255,255,0.7),
         inset 0 -2px 4px rgba(0,0,0,0.1);
  z-index: 1;
  z-index: 1;
    }
    .seat:hover{transform:translateY(-4px) scale(1.05);z-index:10}
    .seat:hover::before{
      box-shadow:0 6px 20px rgba(0,0,0,0.2), 
                 inset 0 2px 4px rgba(255,255,255,0.9),
                 inset 0 -2px 3px rgba(0,0,0,0.15) !important;
    }
    .seat:hover::after{
      box-shadow:0 8px 25px rgba(0,0,0,0.25), 
                 inset 0 2px 5px rgba(255,255,255,0.8),
                 inset 0 -3px 6px rgba(0,0,0,0.2) !important;
    }
    .seat.presente{color:#ffffff}
    .seat.presente::before{
      background:linear-gradient(145deg, var(--present) 0%, rgba(34, 197, 94, 0.9) 100%) !important;
      border-color:#16a34a !important;
      box-shadow:0 3px 15px rgba(34,197,94,0.5), 
                 inset 0 1px 3px rgba(255,255,255,0.4),
                 inset 0 -1px 3px rgba(22, 163, 74, 0.3) !important;
    }
    .seat.presente::after{
      background:linear-gradient(145deg, var(--present) 0%, rgba(34, 197, 94, 0.95) 100%) !important;
      border-color:#16a34a !important;
      box-shadow:0 4px 18px rgba(34,197,94,0.6), 
                 inset 0 1px 4px rgba(255,255,255,0.3),
                 inset 0 -2px 4px rgba(22, 163, 74, 0.4) !important;
    }
    
    .seat.absent{color:#fff}
    .seat.absent::before{
      background:linear-gradient(145deg, var(--absent) 0%, rgba(239, 68, 68, 0.9) 100%) !important;
      border-color:#dc2626 !important;
      box-shadow:0 3px 15px rgba(239,68,68,0.5), 
                 inset 0 1px 3px rgba(255,255,255,0.3),
                 inset 0 -1px 3px rgba(220, 38, 38, 0.3) !important;
    }
    .seat.absent::after{
      background:linear-gradient(145deg, var(--absent) 0%, rgba(239, 68, 68, 0.95) 100%) !important;
      border-color:#dc2626 !important;
      box-shadow:0 4px 18px rgba(239,68,68,0.6), 
                 inset 0 1px 4px rgba(255,255,255,0.25),
                 inset 0 -2px 4px rgba(220, 38, 38, 0.4) !important;
    }
    .seat.highlight{outline:3px solid var(--brand-secondary);outline-offset:3px;z-index:10;position:relative;box-shadow:0 0 20px rgba(86, 180, 198, 0.5)}

    /* Asientos con colores especiales */
    .seat.color-violeta{color:#ffffff !important}
    .seat.color-violeta::before{
      background:linear-gradient(145deg, var(--role-jurado) 0%, rgba(139, 92, 246, 0.9) 100%) !important;
      border-color:#7C3AED !important;
      box-shadow:0 3px 12px rgba(139, 92, 246, 0.4), 
                 inset 0 1px 3px rgba(255,255,255,0.3),
                 inset 0 -1px 3px rgba(124, 58, 237, 0.3) !important;
    }
    .seat.color-violeta::after{
      background:linear-gradient(145deg, var(--role-jurado) 0%, rgba(139, 92, 246, 0.95) 100%) !important;
      border-color:#7C3AED !important;
      box-shadow:0 4px 15px rgba(139, 92, 246, 0.5), 
                 inset 0 1px 4px rgba(255,255,255,0.25),
                 inset 0 -2px 4px rgba(124, 58, 237, 0.4) !important;
    }
    
    .seat.color-azul{color:#ffffff !important}
    .seat.color-azul::before{
      background:linear-gradient(145deg, var(--role-funcionario) 0%, rgba(59, 101, 163, 0.9) 100%) !important;
      border-color:var(--brand-primary) !important;
      box-shadow:0 3px 12px rgba(59, 101, 163, 0.4), 
                 inset 0 1px 3px rgba(255,255,255,0.3),
                 inset 0 -1px 3px rgba(59, 101, 163, 0.3) !important;
    }
    .seat.color-azul::after{
      background:linear-gradient(145deg, var(--role-funcionario) 0%, rgba(59, 101, 163, 0.95) 100%) !important;
      border-color:var(--brand-primary) !important;
      box-shadow:0 4px 15px rgba(59, 101, 163, 0.5), 
                 inset 0 1px 4px rgba(255,255,255,0.25),
                 inset 0 -2px 4px rgba(59, 101, 163, 0.4) !important;
    }
    
    .seat.color-naranja{color:#ffffff !important}
    .seat.color-naranja::before{
      background:linear-gradient(145deg, var(--role-ministro) 0%, rgba(249, 115, 22, 0.9) 100%) !important;
      border-color:#EA580C !important;
      box-shadow:0 3px 12px rgba(249, 115, 22, 0.4), 
                 inset 0 1px 3px rgba(255,255,255,0.3),
                 inset 0 -1px 3px rgba(234, 88, 12, 0.3) !important;
    }
    .seat.color-naranja::after{
      background:linear-gradient(145deg, var(--role-ministro) 0%, rgba(249, 115, 22, 0.95) 100%) !important;
      border-color:#EA580C !important;
      box-shadow:0 4px 15px rgba(249, 115, 22, 0.5), 
                 inset 0 1px 4px rgba(255,255,255,0.25),
                 inset 0 -2px 4px rgba(234, 88, 12, 0.4) !important;
    }
    
    .seat.color-negro{color:#ffffff !important}
    .seat.color-negro::before{
      background:linear-gradient(145deg, var(--role-custodia) 0%, rgba(31, 41, 55, 0.9) 100%) !important;
      border-color:#111827 !important;
      box-shadow:0 3px 12px rgba(31, 41, 55, 0.4), 
                 inset 0 1px 3px rgba(255,255,255,0.2),
                 inset 0 -1px 3px rgba(17, 24, 39, 0.5) !important;
    }
    .seat.color-negro::after{
      background:linear-gradient(145deg, var(--role-custodia) 0%, rgba(31, 41, 55, 0.95) 100%) !important;
      border-color:#111827 !important;
      box-shadow:0 4px 15px rgba(31, 41, 55, 0.6), 
                 inset 0 1px 4px rgba(255,255,255,0.15),
                 inset 0 -2px 4px rgba(17, 24, 39, 0.6) !important;
    }
    
  .seat.empty-seat{color:transparent;cursor:default;opacity:1;position:relative}
    .seat.empty-seat:hover{transform:none}
    .seat.empty-seat::before{background:var(--brand-light);border-color:var(--celeste-light)}
    .seat.empty-seat::after{background:var(--brand-light);border-color:var(--celeste-light)}
    .seat-num {
  position: absolute;
  top: -6px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 1.1rem;
  color: var(--brand-primary);
  font-weight: bold;
  z-index: 100;
  pointer-events: none;
  text-shadow: 0 1px 4px #fff, 0 0px 2px #e8f1f8;
    }

    /* Badges de roles */
    .badge{display:inline-flex;align-items:center;gap:8px;background:var(--brand-light);border:2px solid var(--celeste-light);color:var(--brand-primary);padding:8px 14px;border-radius:999px;font-size:.75rem;font-weight:600;box-shadow:var(--shadow-sm);transition:all 0.2s ease}
    .badge:hover{border-color:var(--brand-secondary);box-shadow:var(--shadow);transform:translateY(-1px)}
    .role-dot{width:12px;height:12px;border-radius:4px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}

    /* Modal mejorado */
    dialog {
      border:none;border-radius:24px;background:var(--card);color:var(--text-primary);padding:0;max-width:550px;width:90%;
      box-shadow:var(--shadow-lg);display:none;position:fixed;top:50%;left:50%;transform:translate(-50%, -50%);z-index:999;
      overflow:hidden;border:3px solid var(--brand-light);
    }
    dialog.show { display:block; }
    .modal-header{background:linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));color:#ffffff;padding:24px 28px;text-align:center}
    .modal-header h3{margin:0;font-size:1.3rem;font-weight:800}
    .modal-body{padding:28px}
    #detalleInfo {
      background:var(--brand-light);border:2px solid var(--celeste-light);padding:24px;border-radius:16px;line-height:1.7;font-size:15px;color:var(--text-primary);
    }
    .info-grid{display:grid;grid-template-columns:1fr 2fr;gap:16px 20px;align-items:center}
    .info-label{font-weight:700;color:var(--brand-primary)}
    .info-value{color:var(--text-primary);font-weight:500}
    .modal-actions {display:flex;justify-content:center;margin-top:24px;}
    .overlay {position:fixed;inset:0;background:rgba(59, 101, 163, 0.4);display:none;z-index:998;backdrop-filter:blur(4px)}
    .overlay.show { display:block; }

    /* Responsive */
    @media (max-width: 1200px){
      .content{grid-template-columns:1fr;gap:16px}
      .side{order:2}
      .stage{order:1}
    }
    @media (max-width: 768px){
      .topbar{flex-direction:column;gap:12px;text-align:center}
      .brand{justify-content:center}
      .metrics{justify-content:center}
      .wrap{padding:12px 16px}
      .header-logo{width:65px;height:65px}
      .content{padding:0 16px}
      .stage-head{flex-direction:column;align-items:stretch;gap:12px}
      .grid{--size:28px;gap:6px}
      .seat{font-size:.65rem}
      .kpi{min-width:120px;padding:8px 12px}
      .kpi .val{font-size:1.1rem}
    }
    @media (max-width: 480px){
      .grid{--size:24px;gap:4px}
      .seat{font-size:.6rem}
      .sector{padding:12px}
      .modal-body{padding:16px}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap topbar">
      <div class="brand">
        <div class="title">
          <p class="institution">Ministerio de Educación</p>
          <h1 class="system-title">Designación de Cargos Jerárquicos &gt; Salón Islas Malvinas</h1>
        </div>
      </div>
      <div class="metrics" id="metrics">
        <div class="kpi"><span class="label">Total Registrados</span><span class="val" id="kpi-total">0</span></div>
        <div class="kpi"><span class="label">Presentes</span><span class="val" id="kpi-present">0</span></div>
        <div class="kpi"><span class="label">Ausentes</span><span class="val" id="kpi-absent">0</span></div>
        <div class="kpi"><span class="label">Ocupación</span><span class="val" id="kpi-ocupa">0%</span></div>
      </div>
    </div>
  </header>

  <main class="content">
    <!-- Panel lateral: leyenda y controles -->
    <aside class="side">
      <h3>Estado de Asistencia</h3>
      <div class="legend">
        <div class="muted">Disponible</div>
        <div class="dot" style="background:var(--seat)"></div>
        <div class="muted">Presente</div>
        <div class="dot" style="background:var(--present)"></div>
        <div class="muted">Ausente</div>
        <div class="dot" style="background:var(--absent)"></div>
      </div>

      <h3>Roles Institucionales</h3>
      <div class="legend">
        <div class="muted">Jurados</div>
        <div class="dot" style="background:#8B5CF6"></div>
        <div class="muted">Funcionarios</div>
        <div class="dot" style="background:#3B82F6"></div>
        <div class="muted">Ministro</div>
        <div class="dot" style="background:#F97316"></div>
        <div class="muted">Custodia</div>
        <div class="dot" style="background:#1F2937"></div>
      </div>

      <div class="controls">
        <input id="search" type="text" placeholder="Buscar por asiento (ej: 150)" />
        <select id="filter">
          <option value="all">Ver: Todos</option>
          <option value="present">Solo presentes</option>
          <option value="absent">Solo ausentes</option>
          <option value="empty">Solo disponibles</option>
        </select>
        <button class="btn" id="btnRefresh">Actualizar Datos</button>
      </div>

      <div class="connection-status" id="connectionStatus">
        <span class="connection-dot"></span>
        <span>Conectando...</span>
      </div>

      <p class="muted" style="margin-top:12px;font-size:0.8rem">
        <strong>Instrucciones:</strong><br>
        • Haga clic en un asiento para ver detalles<br>
        • Los asientos se actualizan en tiempo real<br>
        • Use los filtros para una vista específica
      </p>
    </aside>

    <!-- Plano -->
    <section class="stage">
      <div class="stage-head">
        <div class="stage-label">Plano de Asientos - 260 Ubicaciones</div>
        <div class="zoom">
          <span class="muted">Tamaño</span>
          <input id="zoom" type="range" min="24" max="48" value="32" />
        </div>
      </div>

      <div class="sectors" id="sectors">
        <!-- Sectores se generan dinámicamente -->
      </div>

      <div style="margin-top:16px;display:flex;gap:10px;flex-wrap:wrap;justify-content:center">
        <span class="badge"><span class="role-dot" style="background:#8B5CF6"></span>Jurados de Oposición y Apelación</span>
        <span class="badge"><span class="role-dot" style="background:#3B82F6"></span>Funcionarios</span>
        <span class="badge"><span class="role-dot" style="background:#F97316"></span>Ministro de Educación</span>
        <span class="badge"><span class="role-dot" style="background:#1F2937"></span>Custodia del Gobernador</span>
      </div>

      <p class="muted" style="margin-top:12px;text-align:center;font-size:0.85rem">
        Organización: <strong>2 sectores de 10 columnas × 13 filas</strong> | Total: <strong>260 asientos</strong> | Actualización: <strong>Tiempo real</strong>
      </p>
    </section>
  </main>

  <!-- Modal mejorado -->
  <div class="overlay" id="overlay"></div>
  <dialog id="modalDetalle">
    <div class="modal-header">
      <h3>Información del Asistente</h3>
    </div>
    <div class="modal-body">
      <div id="detalleInfo"></div>
      <div class="modal-actions">
        <button id="cerrarModal" class="btn">Cerrar</button>
      </div>
    </div>
  </dialog>

  <script>
    // Configuración Supabase
    const SUPABASE_URL = 'https://csbcfhwdpstnofvsfqwh.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNzYmNmaHdkcHN0bm9mdnNmcXdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMjkzODcsImV4cCI6MjA3MTcwNTM4N30.lX166U64tFeqKd6snFduL-oXWD_LXwzPMyQYVF3g8ek';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Variables globales
    const sectorsEl = document.getElementById('sectors');
    const kpiTotal = document.getElementById('kpi-total');
    const kpiPresent = document.getElementById('kpi-present');
    const kpiAbsent = document.getElementById('kpi-absent');
    const kpiOcupa = document.getElementById('kpi-ocupa');
    const modal = document.getElementById('modalDetalle');
    const overlay = document.getElementById('overlay');
    const detalleInfo = document.getElementById('detalleInfo');
    const cerrarModal = document.getElementById('cerrarModal');
    const connectionStatus = document.getElementById('connectionStatus');

    let dataAsistencia = {};

    // Configuración de sectores
    const SECTORES = [
      { id: 1, titulo: 'Sector 1', inicio: 1, fin: 130 },
      { id: 2, titulo: 'Sector 2', inicio: 131, fin: 260 }
    ];

    // Funciones de UI
    function abrirModal() {
      modal.classList.add('show');
      overlay.classList.add('show');
    }

    function cerrar() {
      modal.classList.remove('show');
      overlay.classList.remove('show');
    }

    // Crear sectores dinámicamente
    function crearSectores() {
      sectorsEl.innerHTML = '';
      
      SECTORES.forEach(sector => {
        const sectorDiv = document.createElement('div');
        sectorDiv.className = 'sector';

        const header = document.createElement('div');
        header.className = 'sector-head';
        header.innerHTML = `
          <div class="sector-title">${sector.titulo}</div>
          <div class="sector-info">10 × 13 (${sector.fin - sector.inicio + 1} asientos)</div>
        `;

        const grid = document.createElement('div');
        grid.className = 'grid';
        grid.style.setProperty('--size', document.getElementById('zoom').value + 'px');

        // Reinicio de numeración para asientos grises sector 1
        let emptySeatCounter = 1;

        let filaIndex = 0;
        for (let i = sector.inicio; i <= sector.fin; i += 10) {
          for (let j = i; j < i + 10 && j <= sector.fin; j++) {
            const seat = document.createElement('div');
            seat.className = 'seat';
            seat.dataset.id = j;
            seat.title = `Asiento ${j}`;

            // Las primeras dos filas no tienen números
            if (filaIndex >= 2) {
              seat.textContent = j;
              seat.addEventListener('click', () => mostrarDetalle(seat));
            } else {
              seat.textContent = '';
              let hasColor = false;
              const seatPosition = (j - i) + 1;

              // Primera fila
              if (filaIndex === 0) {
                if (seatPosition === 1) {
                  seat.classList.add('color-violeta');
                  hasColor = true;
                } else if (seatPosition >= 2 && seatPosition <= 4) {
                  seat.classList.add('color-azul');
                  hasColor = true;
                } else if (seatPosition === 5 || seatPosition === 6) {
                  seat.classList.add('color-naranja');
                  hasColor = true;
                } else if (seatPosition >= 7 && seatPosition <= 10) {
                  seat.classList.add('color-azul');
                  hasColor = true;
                }
              } else if (filaIndex === 1) {
                if (seatPosition === 5) {
                  seat.classList.add('color-negro');
                  hasColor = true;
                } else {
                  seat.classList.add('color-violeta');
                  hasColor = true;
                }
              }

              // Última fila de cada sector
              if (filaIndex === 12) {
                if (sector.id === 1) {
                  seat.classList.add('color-azul');
                  hasColor = true;
                } else {
                  seat.classList.add('color-violeta');
                  hasColor = true;
                }
              }

              if (!hasColor) {
                seat.classList.add('empty-seat');
                // Enumerar solo los grises del sector 1 y hasta el 100
                if (sector.id === 1 && emptySeatCounter <= 100) {
                  // Elimina cualquier contenido previo
                  seat.innerHTML = '';
                  const numSpan = document.createElement('span');
                  numSpan.className = 'seat-num';
                  numSpan.textContent = emptySeatCounter;
                  seat.appendChild(numSpan);
                  emptySeatCounter++;
                }
              } else {
                seat.addEventListener('click', () => mostrarDetalle(seat));
              }
            }
            grid.appendChild(seat);
          }
          filaIndex++;
        }
        sectorDiv.appendChild(header);
        sectorDiv.appendChild(grid);
        sectorsEl.appendChild(sectorDiv);
      });
    }

    // Cargar datos de Supabase
    async function cargarDatos() {
      try {
        const { data, error } = await supabase
          .from('asistencia')
          .select('*');
        
        if (error) throw error;
        
        dataAsistencia = {};
        data.forEach(registro => {
          dataAsistencia[registro.dni] = registro;
        });
        
        actualizarEstadisticas();
        actualizarAsientosPresentes();
        
        connectionStatus.innerHTML = '<span class="connection-dot"></span><span>Conectado en tiempo real</span>';
        connectionStatus.style.color = 'var(--present)';
        
      } catch (error) {
        console.error('Error cargando datos:', error);
        connectionStatus.innerHTML = '<span style="color:var(--absent)">●</span><span>Error de conexión</span>';
        connectionStatus.style.color = 'var(--absent)';
      }
    }

    // Actualizar estadísticas
    function actualizarEstadisticas() {
      const total = Object.keys(dataAsistencia).length;
      const presentes = Object.values(dataAsistencia).filter(p => p.presente).length;
      const ausentes = total - presentes;
      const ocupacion = Math.round((presentes / 260) * 100);
      
      kpiTotal.textContent = total;
      kpiPresent.textContent = presentes;
      kpiAbsent.textContent = ausentes;
      kpiOcupa.textContent = `${ocupacion}%`;
    }

    // Actualizar asientos presentes
    function actualizarAsientosPresentes() {
      document.querySelectorAll('.seat').forEach(seat => {
        seat.classList.remove('presente');
      });
      
      Object.values(dataAsistencia).forEach(info => {
        if (info.presente) {
          const seat = document.querySelector(`.seat[data-id="${info.asiento}"]`);
          if (seat) seat.classList.add('presente');
        }
      });
    }

    // Mostrar detalle de asiento
    function mostrarDetalle(seat) {
      const id = seat.dataset.id;
      const registro = Object.entries(dataAsistencia).find(([dni, info]) => info.asiento == id);
      
      // Determinar tipo de asiento por color
      let tipoAsiento = '';
      if (seat.classList.contains('color-violeta')) {
        tipoAsiento = 'JURADOS DE OPOSICION Y APELACION';
      } else if (seat.classList.contains('color-azul')) {
        tipoAsiento = 'FUNCIONARIOS';
      } else if (seat.classList.contains('color-naranja')) {
        tipoAsiento = 'MINISTRO DE EDUCACIÓN';
      } else if (seat.classList.contains('color-negro')) {
        tipoAsiento = 'CUSTODIA DEL GOBERNADOR';
      }
      
      if (registro) {
        const [dni, info] = registro;
        const fechaAsistencia = info.fecha_asistencia 
          ? new Date(info.fecha_asistencia).toLocaleString('es-ES')
          : 'No registrada';
        
        const asientoInfo = tipoAsiento ? tipoAsiento : `Asiento ${info.asiento}`;
        
        detalleInfo.innerHTML = `
          <div class="info-grid">
            <span class="info-label">Región:</span>
            <span class="info-value">${info.region}</span>
            <span class="info-label">Establecimiento:</span>
            <span class="info-value">${info.establecimiento}</span>
            <span class="info-label">Cargo:</span>
            <span class="info-value">${info.cargo}</span>
            <span class="info-label">Aspirante:</span>
            <span class="info-value">${info.aspirante}</span>
            <span class="info-label">DNI:</span>
            <span class="info-value">${info.dni}</span>
            <span class="info-label">Ubicación:</span>
            <span class="info-value">${asientoInfo}</span>
            <span class="info-label">Estado:</span>
            <span class="info-value" style="color:${info.presente ? 'var(--present)' : 'var(--text-secondary)'};font-weight:700">
              ${info.presente ? '✓ Presente' : '○ Ausente'}
            </span>
            <span class="info-label">Fecha Asistencia:</span>
            <span class="info-value">${fechaAsistencia}</span>
          </div>
        `;
        
        abrirModal();
      } else {
        if (tipoAsiento) {
          detalleInfo.innerHTML = `
            <div style="text-align:center;padding:20px">
              <h4 style="color:var(--brand-primary);margin-bottom:12px;font-size:1.1rem">${tipoAsiento}</h4>
              <p style="color:var(--text-secondary);margin:0">RESERVADO</p>
            </div>
          `;
        } else {
          detalleInfo.innerHTML = `
            <div style="text-align:center;padding:20px">
              <p style="color:var(--text-secondary);margin:0">Asiento sin asignar</p>
            </div>
          `;
        }
        abrirModal();
      }
    }

    // Filtros
    function filterSeats(mode) {
      document.querySelectorAll('.seat').forEach(seat => {
        const id = seat.dataset.id;
        const registro = Object.values(dataAsistencia).find(info => info.asiento == id);
        let show = true;
        
        if (mode === 'present') show = registro && registro.presente;
        if (mode === 'absent') show = registro && !registro.presente;
        if (mode === 'empty') show = !registro;
        
        seat.style.opacity = show ? 1 : 0.2;
      });
    }

    // Búsqueda
    function buscarAsiento(query) {
      document.querySelectorAll('.seat').forEach(seat => seat.classList.remove('highlight'));
      if (!query) return;
      
      const target = document.querySelector(`.seat[data-id="${query}"]`);
      if (target) {
        target.classList.add('highlight');
        target.scrollIntoView({behavior:'smooth', block:'center', inline:'center'});
      }
    }

    // Suscripción tiempo real
    function suscribirCambios() {
      supabase
        .channel('panel-changes')
        .on('postgres_changes', 
          { event: '*', schema: 'public', table: 'asistencia' }, 
          (payload) => {
            setTimeout(() => {
              cargarDatos();
            }, 500);
          }
        )
        .subscribe((status) => {
          if (status === 'SUBSCRIBED') {
            connectionStatus.innerHTML = '<span class="connection-dot"></span><span>Conectado en tiempo real</span>';
            connectionStatus.style.color = 'var(--present)';
          }
        });
    }

    // Event Listeners
    document.getElementById('zoom').addEventListener('input', (e) => {
      document.querySelectorAll('.grid').forEach(grid => {
        grid.style.setProperty('--size', e.target.value + 'px');
      });
    });

    document.getElementById('filter').addEventListener('change', (e) => {
      filterSeats(e.target.value);
    });

    document.getElementById('search').addEventListener('input', (e) => {
      buscarAsiento(e.target.value.trim());
    });

    document.getElementById('btnRefresh').addEventListener('click', cargarDatos);

    cerrarModal.addEventListener('click', cerrar);
    overlay.addEventListener('click', cerrar);

    // Inicialización
    crearSectores();
    cargarDatos().then(() => {
      suscribirCambios();
    });

    // Auto-actualización cada 30 segundos
    setInterval(() => {
      cargarDatos();
    }, 30000);
  </script>
</body>
</html>
