<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Búsqueda de Asistentes - Ministerio de Educación</title>
    <link rel="icon" href="data:,">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --brand: #1e3a8a;
            --success: #25d366;
            --error: #dc2626;
            --text: #1f2937;
            --light: #6b7280;
            --bg-light: #f8fafc;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            padding: 5%;
            font-family: Inter, -apple-system, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text);
            font-size: 16px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            border-radius: 1.25em;
            box-shadow: 0 0.75em 2.5em rgba(30, 58, 138, 0.15);
            padding: 5%;
            width: 390px;
            max-width: 100%;
            text-align: center;
            position: relative;
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .header {
            margin-bottom: 1.5em;
        }

        .logo {
            width: 60%;
            max-width: 10em;
            height: auto;
            filter: drop-shadow(0 0.25em 0.5em rgba(30, 58, 138, 0.15));
        }

        .title {
            font-size: 1.25em;
            font-weight: 700;
            color: var(--brand);
            margin: 0.75em 0;
        }

        .intro {
            font-size: 0.875em;
            color: var(--light);
            line-height: 1.4;
            margin-bottom: 1.25em;
        }

        .form {
            margin-bottom: 1em;
        }

        .input {
            width: 100%;
            padding: 0.75em;
            border: 2px solid #d1d5db;
            border-radius: 0.5em;
            font-size: 0.875em;
            background: #f3f4f6;
            text-align: center;
            margin-bottom: 0.75em;
            transition: all 0.3s ease;
        }

        .input:focus {
            outline: none;
            border-color: var(--brand);
            background: white;
            box-shadow: 0 0 0 0.1875em rgba(30, 58, 138, 0.2);
        }

        .btn {
            width: 100%;
            padding: 0.75em;
            border: none;
            border-radius: 0.5em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.875em;
        }

        .btn-primary {
            background: var(--brand);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #1e40af;
            transform: translateY(-0.125em);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #22c55e;
            transform: translateY(-0.125em);
        }

        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .results {
            margin-top: 1em;
            opacity: 0;
            max-height: 0;
            overflow: hidden;
            transition: all 0.4s ease;
            border-top: 1px solid #e5e7eb;
            padding-top: 0;
        }

        .results.show {
            opacity: 1;
            max-height: 500px;
            padding-top: 1em;
        }

        .user-card {
            background: var(--bg-light);
            border-radius: 0.75em;
            padding: 1em;
            margin-bottom: 1em;
            text-align: left;
            border: 1px solid #e5e7eb;
        }

        .user-name {
            font-size: 1.125em;
            font-weight: 700;
            color: var(--brand);
            margin-bottom: 0.5em;
            text-align: center;
        }

        .detail {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5em 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .detail:last-of-type {
            border-bottom: none;
            margin-bottom: 1em;
        }

        .detail-label {
            font-weight: 600;
            color: var(--light);
            font-size: 0.875em;
        }

        .detail-value {
            font-size: 0.875em;
            text-align: right;
        }

        .status {
            padding: 0.25em 0.5em;
            border-radius: 0.375em;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-present { background: #dcfce7; color: #166534; }
        .status-absent { background: #fef2f2; color: #991b1b; }

        .message {
            font-size: 0.875em;
            padding: 1em;
            border-radius: 0.5em;
            font-weight: 600;
            text-align: center;
            margin-top: 1em;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .message.show { opacity: 1; }

        .message-success {
            background: #dcfce7;
            color: #166534;
        }

        .message-error {
            background: #fef2f2;
            color: var(--error);
        }

        .loading {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            border-radius: 1.25em;
        }

        .spinner {
            width: 2em; height: 2em;
            border: 0.25em solid #f3f4f6;
            border-top: 0.25em solid var(--brand);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 450px) {
            body { padding: 3%; }
            .card { width: 95vw; padding: 6%; }
        }
    </style>
</head>
<body>
    <div class="card">
        <div class="loading" id="loading">
            <div class="spinner"></div>
        </div>

        <div class="header">
            <img src="LOGO NUEVO COLOR_122003.png" alt="Ministerio de Educación" class="logo">
        </div>

        <h1 class="title">Búsqueda de Asistentes</h1>
        <p class="intro">Ingrese el DNI para verificar identidad y dar asistencia.</p>

        <form class="form" onsubmit="searchUser(event)">
            <input type="text" class="input" id="dni" placeholder="Ingrese DNI..." required pattern="[0-9]+" title="Solo números">
            <button type="submit" class="btn btn-primary" id="searchBtn">Buscar</button>
        </form>

        <div class="message message-error" id="error"></div>

        <div class="results" id="results">
            <div class="user-card">
                <div class="user-name" id="name"></div>
                <div class="detail">
                    <span class="detail-label">DNI:</span>
                    <span class="detail-value" id="cedula"></span>
                </div>
                <div class="detail">
                    <span class="detail-label">Cargo:</span>
                    <span class="detail-value" id="cargo"></span>
                </div>
                <div class="detail">
                    <span class="detail-label">Dependencia:</span>
                    <span class="detail-value" id="dependencia"></span>
                </div>
                <div class="detail">
                    <span class="detail-label">Estado:</span>
                    <span class="detail-value" id="estado"></span>
                </div>
                <button class="btn btn-success" onclick="giveAttendance()">Dar Asistencia</button>
            </div>
        </div>

        <div class="message message-success" id="success">¡Asistencia registrada exitosamente!</div>
    </div>

    <script>
        // 🔗 CONEXIÓN A SUPABASE - TABLA DE FUNCIONARIOS
        const supabase = window.supabase.createClient(
            'https://pjcokjzxzgefpdmbkuop.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBqY29ranp4emdlZnBkbWJrdW9wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjgwOTU4MDEsImV4cCI6MjA0MzY3MTgwMX0.m6p56KgGnlqSsJJJYCCqPbYMB6x_FjFyO5R5mRANY5c'
        );

        let currentUser = null;

        // Cache de elementos DOM
        const elements = {
            loading: document.getElementById('loading'),
            searchBtn: document.getElementById('searchBtn'),
            dni: document.getElementById('dni'),
            results: document.getElementById('results'),
            error: document.getElementById('error'),
            success: document.getElementById('success'),
            name: document.getElementById('name'),
            cedula: document.getElementById('cedula'),
            cargo: document.getElementById('cargo'),
            dependencia: document.getElementById('dependencia'),
            estado: document.getElementById('estado')
        };

        function showLoading(show) {
            elements.loading.style.display = show ? 'flex' : 'none';
            elements.searchBtn.disabled = show;
        }

        function showError(message) {
            elements.error.textContent = message;
            elements.error.classList.add('show');
            setTimeout(() => elements.error.classList.remove('show'), 5000);
        }

        function clearResults() {
            elements.results.classList.remove('show');
            elements.success.classList.remove('show');
            elements.error.classList.remove('show');
            currentUser = null;
        }

        function showUser(user) {
            elements.name.textContent = user.nombre;
            elements.cedula.textContent = user.cedula;
            elements.cargo.textContent = user.cargo || 'No especificado';
            elements.dependencia.textContent = user.dependencia || 'No especificada';
            
            const today = new Date().toISOString().split('T')[0];
            const hasAttendance = user.attendance?.some(a => a.fecha === today && a.presente);
            
            elements.estado.innerHTML = hasAttendance 
                ? '<span class="status status-present">Presente</span>'
                : '<span class="status status-absent">Ausente</span>';
            
            elements.results.classList.add('show');
            currentUser = user;
        }

        // 🔍 BÚSQUEDA EN TABLA DE FUNCIONARIOS POR DNI
        async function searchUser(event) {
            event.preventDefault();
            
            const dni = elements.dni.value.trim();
            if (!dni) {
                showError('Por favor ingrese un DNI');
                return;
            }

            // Validar que solo contenga números
            if (!/^\d+$/.test(dni)) {
                showError('El DNI debe contener solo números');
                return;
            }

            clearResults();
            showLoading(true);

            try {
                console.log('🔍 Buscando DNI en Supabase:', dni);
                
                // BÚSQUEDA EN TABLA 'funcionarios' POR CAMPO 'cedula'
                const { data: users, error } = await supabase
                    .from('funcionarios')
                    .select(`
                        id,
                        nombre,
                        cedula,
                        cargo,
                        dependencia,
                        attendance:asistencias(fecha, presente)
                    `)
                    .eq('cedula', dni)
                    .limit(1);

                console.log('📊 Respuesta de Supabase:', { users, error });

                if (error) {
                    console.error('❌ Error de Supabase:', error);
                    throw error;
                }

                if (users?.length > 0) {
                    console.log('✅ Usuario encontrado:', users[0]);
                    showUser(users[0]);
                } else {
                    console.log('❌ No se encontró usuario con DNI:', dni);
                    showError('No se encontró funcionario con ese DNI en la base de datos');
                }
            } catch (error) {
                console.error('❌ Error en búsqueda:', error);
                showError('Error al buscar en la base de datos: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // 📝 REGISTRAR ASISTENCIA EN TABLA 'asistencias'
        async function giveAttendance() {
            if (!currentUser) return;

            showLoading(true);
            
            try {
                const today = new Date().toISOString().split('T')[0];
                const now = new Date().toISOString();

                console.log('📝 Registrando asistencia para:', currentUser.nombre);

                // Verificar si ya existe asistencia para hoy
                const { data: existing, error: checkError } = await supabase
                    .from('asistencias')
                    .select('*')
                    .eq('funcionario_id', currentUser.id)
                    .eq('fecha', today)
                    .single();

                if (checkError && checkError.code !== 'PGRST116') throw checkError;

                if (existing) {
                    // Actualizar asistencia existente
                    const { error } = await supabase
                        .from('asistencias')
                        .update({ 
                            presente: true, 
                            hora_entrada: now, 
                            updated_at: now 
                        })
                        .eq('id', existing.id);
                    
                    if (error) throw error;
                    console.log('✅ Asistencia actualizada');
                } else {
                    // Crear nueva asistencia
                    const { error } = await supabase
                        .from('asistencias')
                        .insert({
                            funcionario_id: currentUser.id,
                            fecha: today,
                            presente: true,
                            hora_entrada: now,
                            created_at: now,
                            updated_at: now
                        });
                    
                    if (error) throw error;
                    console.log('✅ Nueva asistencia registrada');
                }

                elements.success.classList.add('show');
                
                setTimeout(() => {
                    clearResults();
                    elements.dni.value = '';
                    elements.dni.focus();
                }, 2000);

            } catch (error) {
                console.error('❌ Error al registrar asistencia:', error);
                showError('Error al registrar asistencia: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // 🚀 INICIALIZACIÓN
        document.addEventListener('DOMContentLoaded', function() {
            elements.dni.focus();
            console.log('✅ Sistema de búsqueda de asistentes iniciado');
            console.log('📊 Conectado a Supabase - Tabla: funcionarios');
        });

        // Validación en tiempo real
        elements.dni.addEventListener('input', function(e) {
            // Solo permitir números
            e.target.value = e.target.value.replace(/\D/g, '');
        });
    </script>
</body>
</html>
